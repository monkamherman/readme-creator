generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

type Location {
  coordinates Float[]
}

type OpeningTimeTimes {
  startTime String[]
  endTime   String[]
}

type OpeningTime {
  day   String
  times OpeningTimeTimes[]
}

type Variation {
  id           String   @map("_id") @db.ObjectId
  title        String
  price        Float
  discounted   Float?
  addons       String[]
  isOutOfStock Boolean?
}

type Option {
  id           String   @map("_id") @db.ObjectId
  title        String
  description  String?
  price        Float
  isOutOfStock Boolean?
}

type Addon {
  id              String   @map("_id") @db.ObjectId
  title           String
  description     String?
  quantityMinimum Int
  quantityMaximum Int
  options         Option[]
}

model Restaurant {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  image         String?
  logo          String?
  slug          String        @unique
  username      String?
  password      String?
  phone         String?
  email         String?
  shopType      String?
  address       String?
  location      Location?
  deliveryTime  Int?
  minimumOrder  Float?
  tax           Float?
  reviewAverage Float?
  cuisines      String[]
  isActive      Boolean       @default(true)
  isAvailable   Boolean       @default(true)
  isFeatured    Boolean       @default(false)
  openingTimes  OpeningTime[]
  categories    Category[]
  orders        Order[]
  reviews       Review[]
  zoneId        String?       @db.ObjectId
  zone          Zone?         @relation(fields: [zoneId], references: [id])
  food          Food[]

  // Index géospatial pour les recherches par localisation
  @@index([location], name: "location_2dsphere")
  @@index([isActive, isAvailable, isFeatured], name: "restaurant_status_idx")
  @@index([name], name: "name_idx")
}

model Category {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  title        String
  restaurantId String     @db.ObjectId
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  foods        Food[]
}

model Food {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  title        String
  image        String?
  description  String?
  subCategory  String?
  isOutOfStock Boolean     @default(false)
  variations   Variation[]
  categoryId   String      @db.ObjectId
  category     Category    @relation(fields: [categoryId], references: [id])
  restaurantId String      @db.ObjectId
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId], name: "restaurant_foods_idx")
  @@index([categoryId], name: "category_foods_idx")
  @@index([isOutOfStock], name: "out_of_stock_idx")
}

model User {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  name       String?
  email      String?   @unique
  phone      String?
  password   String?
  userTypeId String?   @db.ObjectId
  orders     Order[]
  reviews    Review[]
  addresses  Address[]

  // Index pour les recherches par téléphone et type d'utilisateur
  @@index([phone], name: "phone_idx")
  @@index([userTypeId], name: "user_type_idx")
}

model Rider {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  name      String?
  username  String?
  password  String?
  phone     String?
  available Boolean?
  location  Location?
  orders    Order[]
}

model Order {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId
  orderId         String     @unique
  restaurantId    String     @db.ObjectId
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id])
  userId          String     @db.ObjectId
  user            User       @relation(fields: [userId], references: [id])
  riderId         String?    @db.ObjectId
  rider           Rider?     @relation(fields: [riderId], references: [id])
  items           Json[]
  deliveryAddress Json?
  paymentMethod   String?
  paidAmount      Float?
  orderAmount     Float?
  orderStatus     String?
  paymentStatus   String?
  tipping         Float?
  taxationAmount  Float?
  createdAt       DateTime   @default(now())
  completionTime  DateTime?
  preparationTime DateTime?
  orderDate       DateTime?
  expectedTime    DateTime?
  isPickedUp      Boolean?
  deliveryCharges Float?
  instructions    String?
  reason          String?
  isRinged        Boolean?
  isRiderRinged   Boolean?
  acceptedAt      DateTime?
  pickedAt        DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?
  assignedAt      DateTime?
  couponId        String?    @db.ObjectId
  coupon          Coupon?    @relation(fields: [couponId], references: [id])
  discountAmount  Float?
  review          Review?

  @@index([userId], name: "user_orders_idx")
  @@index([riderId], name: "rider_orders_idx")
  @@index([restaurantId], name: "restaurant_orders_idx")
  @@index([orderStatus, createdAt], name: "status_created_at_idx")
  @@index([createdAt], name: "created_at_idx")
}

model Coupon {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  code           String    @unique
  title          String?
  discount       Float
  discountType   String? // "percentage" or "fixed"
  minOrderAmount Float?
  maxDiscount    Float?
  enabled        Boolean   @default(true)
  validFrom      DateTime?
  validUntil     DateTime?
  usageLimit     Int?
  usedCount      Int       @default(0)
  restaurantId   String?   @db.ObjectId
  orders         Order[]
  createdAt      DateTime  @default(now())
}

model Review {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  rating       Int
  description  String?
  orderId      String     @unique @db.ObjectId
  order        Order      @relation(fields: [orderId], references: [id])
  restaurantId String     @db.ObjectId
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  userId       String     @db.ObjectId
  user         User       @relation(fields: [userId], references: [id])
  createdAt    DateTime   @default(now())

  // Index pour les recherches par restaurant, utilisateur et note
  @@index([restaurantId], name: "restaurant_reviews_idx")
  @@index([userId], name: "user_reviews_idx")
  @@index([rating], name: "rating_idx")
}

model Zone {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  coordinates Json
  tax         Float?
  restaurants Restaurant[]
}

model Address {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  location Location
  address  String
  userId   String   @db.ObjectId
  user     User     @relation(fields: [userId], references: [id])
}

model Configuration {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  emailUsername  String?
  emailPassword  String?
  currency       String?
  currencySymbol String?
  deliveryRate   Float?
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String
  title     String
  message   String
  type      String
  data      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId], name: "notification_user_idx")
}

model DeviceToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String
  token     String
  platform  String
  createdAt DateTime @default(now())

  @@index([userId], name: "device_token_user_idx")
}
